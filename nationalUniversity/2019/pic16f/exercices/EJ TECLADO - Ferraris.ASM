errorlevel -203, -205, -302
LIST P=16F887
#include <P16F887.inc>
;POWER-UP-TIMER ON,WATCH-DOG OFF,OSC XT CRYSTAL 4MHz,TODO LO DEMAS OFF
__CONFIG _CONFIG1,B'0010000011100001'

CBLOCK 0X20
	fila_init						;INICIALIZACION EN FILA 1
	col_stat						;VARIABLE PARA GUARDAR EL ESTADO DE LAS COLUMNAS
	num_col							;NUMERO DE COLUMNAS
	TECLA							;NUMERO DE TECLA QUE SE ESTA TESTEANDO
	SCANFILE						;TECLA OPRIMIDA EN FORMATO ASCII
ENDC

#define carga_tmr2 MOVLW .178		;CARGA PARA EL TMR2 PARA UN RET DE 20ms aprox

ORG 0
GOTO setup
ORG 4
GOTO INT

ORG 5
setup			CLRF PORTB				;INICIALIZACIONES
				CLRF col_stat
				CLRF TECLA
				CLRF num_col
				CLRF SCANFILE
				MOVLW B'00001110'		;CORRESPONDE A FILA1
				MOVWF fila_init
				BANKSEL ANSELH
				CLRF ANSELH				;PORTB A DIGITAL
				BANKSEL TRISB
				MOVLW 0XF0
				ANDWF TRISB,F			;(RB0-3) OUT, (RB4-7) IN
				BSF PIE1,TMR2IE			;ACTIVA INT POR TMR2
				BANKSEL T2CON
				MOVLW B'01111011'   	;TMR2 PosS = 16, PreS = 16, T2 OFF
 				MOVWF T2CON
				CLRF INTCON				;INICIALIZA BANDERAS
				CLRF PIR1
				BSF INTCON,PEIE			;ACTIVA INT POR PERISFERICOS
				

main			MOVF fila_init,W		;INICIALIZAR EN LA PRIMER FILA, Y PRIMER TECLA
				MOVWF PORTB
				CLRF TECLA				
B1				CALL scan_col			;PREGUNTAR POR TODAS LAS COLUMNAS
				CALL scan_fil			;CAMBIAR DE FILA
				BTFSS TECLA,4			;LISTAS LAS 16 TECLAS?
				GOTO B1 
				GOTO main				;INICIAR LA BUSQUEDA DESDE EL INICIO

scan_col		BSF num_col,2			;VECES = 4
				MOVLW 0XF0				;LIMPIAR Y GUARDAR EL ESTADO ACTUAL DE LAS COLUMNAS
				ANDWF PORTB,W			
				MOVWF col_stat			
sig_col			BTFSS col_stat,4        ;SE PRESIONO TECLA?
				GOTO ret20ms			;SI -> ESPERAR UN TIEMPO ANTES DE DAR EL RESULTADO
				BSF STATUS,C			;NO -> TESTEAR OTRA COLUMNA
				RRF col_stat,F
				INCF TECLA,F
				DECFSZ num_col			;SE TESTEARON TODAS LAS COLUMNAS?
				GOTO sig_col			;NO -> TESTEAR LA SIGUIENTE
				RETURN					;SI -> PASAR A OTRA FILA			

scan_fil		BSF STATUS,C			;AUMENTAR FILA
				RLF PORTB
				RETURN

ret20ms         carga_tmr2				;CARGA PARA UN RET DE 20ms
				MOVWF TMR2
				BSF INTCON,GIE			;ACTVA INT GLOBALES
				BSF T2CON,TMR2ON		;COMIENZA CUENTA
				BTFSS PIR1,TMR2IF		;ESPERA LA INTERRUPCION
				GOTO $-1
				BCF PIR1,TMR2IF			;BAJA LA BANDERA DE TMR2	
				GOTO main

INT				CLRW 					;W = TECLA
				ADDWF TECLA,W
				CALL buscar_tecla		;TABLA PARA ENCONTRAR LA TECLA EN FORM ASCII
				MOVWF SCANFILE			;GUARDA LA TECLA
				RETFIE		

buscar_tecla	ADDWF PCL,F
				RETLW '0'
				RETLW '1'
				RETLW '2'
				RETLW '3'
				RETLW '4'
				RETLW '5'
				RETLW '6'
				RETLW '7'
				RETLW '8'
				RETLW '9'
				RETLW 'A'
				RETLW 'B'
				RETLW 'C'
				RETLW 'D'
				RETLW 'E'
				RETLW 'F'
				RETURN						
END