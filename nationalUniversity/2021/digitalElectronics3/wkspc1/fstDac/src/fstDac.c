/*
===============================================================================
 Name        : fstDac.c
 Author      : $(author)
 Version     :
 Copyright   : $(copyright)
 Description : main definition
===============================================================================
*/

#ifdef __USE_CMSIS
#include "LPC17xx.h"
#endif

#include <cr_section_macros.h>

#include <lpc17xx_timer.h>

//valor para el dac
unsigned short int signal[]={511,514,517,520,524,527,530,533,536,539,542,546,549,552,555,558,
							561,564,567,571,574,577,580,583,586,589,592,595,599,602,605,608,
							611,614,617,620,623,626,629,632,635,638,641,645,648,651,654,657,
							660,663,666,669,672,675,678,681,683,686,689,692,695,698,701,704,
							707,710,713,716,718,721,724,727,730,733,736,738,741,744,747,750,
							752,755,758,761,763,766,769,771,774,777,780,782,785,788,790,793,
							795,798,801,803,806,808,811,813,816,818,821,823,826,828,831,833,
							836,838,841,843,845,848,850,852,855,857,859,862,864,866,868,871,
							873,875,877,880,882,884,886,888,890,892,894,897,899,901,903,905,
							907,909,911,913,915,916,918,920,922,924,926,928,929,931,933,935,
							937,938,940,942,943,945,947,948,950,952,953,955,956,958,959,961,
							962,964,965,967,968,970,971,972,974,975,976,978,979,980,981,983,
							984,985,986,987,988,990,991,992,993,994,995,996,997,998,999,1000,
							1001,1002,1002,1003,1004,1005,1006,1007,1007,1008,1009,1010,1010,
							1011,1012,1012,1013,1013,1014,1015,1015,1016,1016,1017,1017,1018,
							1018,1018,1019,1019,1019,1020,1020,1020,1021,1021,1021,1021,1022,
							1022,1022,1022,1022,1022,1022,1022,1022,1022,1022,1022,1022,1022,
							1022,1022,1022,1022,1022,1022,1021,1021,1021,1021,1021,1020,1020,
							1020,1019,1019,1019,1018,1018,1017,1017,1016,1016,1015,1015,1014,
							1014,1013,1012,1012,1011,1011,1010,1009,1008,1008,1007,1006,1005,
							1005,1004,1003,1002,1001,1000,999,998,997,996,995,994,993,992,991,
							990,989,988,987,986,984,983,982,981,979,978,977,976,974,973,972,970,
							969,967,966,965,963,962,960,959,957,956,954,952,951,949,948,946,944,
							943,941,939,937,936,934,932,930,929,927,925,923,921,919,917,915,914,
							912,910,908,906,904,902,900,898,896,893,891,889,887,885,883,881,878,
							876,874,872,870,867,865,863,861,858,856,854,851,849,847,844,842,839,
							837,835,832,830,827,825,822,820,817,815,812,810,807,804,802,799,797,
							794,791,789,786,784,781,778,776,773,770,767,765,762,759,756,754,751,
							748,745,743,740,737,734,731,728,726,723,720,717,714,711,708,705,703,
							700,697,694,691,688,685,682,679,676,673,670,667,664,661,658,655,652,
							649,646,643,640,637,634,631,628,625,622,619,616,612,609,606,603,600,
							597,594,591,588,585,581,578,575,572,569,566,563,560,556,553,550,547,
							544,541,538,535,531,528,525,522,519,516,513,509,506,503,500,497,494,
							491,487,484,481,478,475,472,469,466,462,459,456,453,450,447,444,441,
							437,434,431,428,425,422,419,416,413,410,406,403,400,397,394,391,388,
							385,382,379,376,373,370,367,364,361,358,355,352,349,346,343,340,337,
							334,331,328,325,322,319,317,314,311,308,305,302,299,296,294,291,288,
							285,282,279,277,274,271,268,266,263,260,257,255,252,249,246,244,241,
							238,236,233,231,228,225,223,220,218,215,212,210,207,205,202,200,197,
							195,192,190,187,185,183,180,178,175,173,171,168,166,164,161,159,157,
							155,152,150,148,146,144,141,139,137,135,133,131,129,126,124,122,120,
							118,116,114,112,110,108,107,105,103,101,99,97,95,93,92,90,88,86,85,
							83,81,79,78,76,74,73,71,70,68,66,65,63,62,60,59,57,56,55,53,52,50,
							49,48,46,45,44,43,41,40,39,38,36,35,34,33,32,31,30,29,28,27,26,25,
							24,23,22,21,20,19,18,17,17,16,15,14,14,13,12,11,11,10,10,9,8,8,7,
							7,6,6,5,5,4,4,3,3,3,2,2,2,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
							0,0,0,0,0,0,1,1,1,1,2,2,2,3,3,3,4,4,4,5,5,6,6,7,7,8,9,9,10,10,11,
							12,12,13,14,15,15,16,17,18,19,20,20,21,22,23,24,25,26,27,28,29,30,
							31,32,34,35,36,37,38,39,41,42,43,44,46,47,48,50,51,52,54,55,57,58,
							60,61,63,64,66,67,69,70,72,74,75,77,79,80,82,84,85,87,89,91,93,94,
							96,98,100,102,104,106,107,109,111,113,115,117,119,121,123,125,128,
							130,132,134,136,138,140,142,145,147,149,151,154,156,158,160,163,165,
							167,170,172,174,177,179,181,184,186,189,191,194,196,199,201,204,206,
							209,211,214,216,219,221,224,227,229,232,234,237,240,242,245,248,251,
							253,256,259,261,264,267,270,272,275,278,281,284,286,289,292,295,298,
							301,304,306,309,312,315,318,321,324,327,330,333,336,339,341,344,347,
							350,353,356,359,362,365,368,371,374,377,381,384,387,390,393,396,399,
							402,405,408,411,414,417,420,423,427,430,433,436,439,442,445,448,451,
							455,458,461,464,467,470,473,476,480,483,486,489,492,495,498,502,505,
							508,511};

volatile unsigned short int n=0;

unsigned short int dacval=0;

/*
 * Funciones auxiliares
 */
void cfgDac(){
	/*
	 * Orden de configuracion DAC:
	 * * pwr/pines(PINSEL, PINMODE), clk(PCLKSEL),
	 * * tiempo de conversion(DACR)
	 */
	//p0.26 pull-off, bloque dac operativo (habilitar funcion)
	LPC_PINCON->PINMODE1|=0b10<<20;
	LPC_PINCON->PINSEL1|=0b10<<20;

	//clk del bloque a 25MHz (default)

	//DAC max-rate 1MHz (default)

	//limpiar salida
	LPC_DAC->DACR&=~(0x3FF<<6);

	return;
}

void cfgTimer(){
	/*
	 * Configurar timer a 25MHz para 500ms
	 */
	TIM_TIMERCFG_Type cfgTmr;
	TIM_GetDefaultCfg(&cfgTmr);

	//prescaler 100E3 (cmsis SI resta el 1)
	cfgTmr.PrescaleValue=125;

	//cargar config y reset
	TIM_Init(LPC_TIM0, TIM_TIMER_MODE, &cfgTmr);
	TIM_ResetCounter(LPC_TIM0);

	//match 125 (cmsis NO resta el 1), canal 0, interrupcion en match
	TIM_MATCHCFG_Type cfgMatch;
	TIM_GetDefaultMatch(&cfgMatch);

	cfgMatch.IntOnMatch=ENABLE;
	cfgMatch.MatchChannel=0;
	cfgMatch.MatchValue=10-1;

	//cargar config de match
	TIM_ConfigMatch(LPC_TIM0, &cfgMatch);

	//bajar banderas y cargar en NVIC
	TIM_ClearIntPending(LPC_TIM0, TIM_MR0_INT);
	NVIC_ClearPendingIRQ(TIMER0_IRQn);
	NVIC_EnableIRQ(TIMER0_IRQn);

	return;
}

/*
 * Handlers
 */
void TIMER0_IRQHandler(){
	//bajar banderas
	TIM_ClearIntPending(LPC_TIM0, TIM_MR0_INT);

	//colocar valor en el dac
	LPC_DAC->DACR=(*(signal+n) & 0x3FF)<<6;

	//LPC_GPIO0->FIODIR|=(1<<22);
	//LPC_GPIO0->FIOPIN^=(1<<22);

	//incrementar valor
	//signal=(unsigned short int)(1023*(sinf((float)(2*3.14*n/1023)) + 1)/2);

	if(n<1024) n++;
	else n=0;

	return;
}

int main(void) {
	/*
	 * Core init
	 */
	SystemInit();

	//config dac
	cfgDac();

    //config timer
	cfgTimer();

	//timer on
	TIM_Cmd(LPC_TIM0, ENABLE);

    while(1) {
    	//leer valor del dac
        dacval=(LPC_DAC->DACR>>6)&0x3FF;

    	__asm volatile ("nop");
    }
    return 0 ;
}
